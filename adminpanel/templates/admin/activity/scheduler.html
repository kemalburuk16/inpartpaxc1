{% extends "admin/base.html" %}

{% block title %}Zamanlayıcı · Admin{% endblock %}

{% block content %}
<div class="container-narrow">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1">⏰ Zamanlayıcı</h2>
      <p class="text-muted">Otomatik aktivite programlama ve ayarları</p>
    </div>
    <div>
      <a href="{{ url_for('activity.dashboard') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Dashboard'a Dön
      </a>
    </div>
  </div>

  <!-- Main Activity Settings -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Ana Aktivite Ayarları</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label">Sistem Durumu</label>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="activityEnabled" {{ 'checked' if config.enabled }}>
              <label class="form-check-label" for="activityEnabled">
                Otomatik aktivite sistemi aktif
              </label>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label">Session Canlı Tutma Aralığı (saniye)</label>
            <input type="number" class="form-control" id="keepAliveInterval" value="{{ config.session_keep_alive_interval }}" min="300" max="7200">
            <div class="form-text">Session'ları canlı tutmak için aktivite aralığı (5 dk - 2 saat)</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Timing Settings -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Zamanlama Ayarları</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <h6>Beğeni Ayarları</h6>
          <div class="mb-3">
            <label class="form-label">Günlük Beğeni Limiti</label>
            <input type="number" class="form-control" id="dailyLikeLimit" value="{{ config.daily_like_limit }}" min="1" max="1000">
          </div>
          <div class="row">
            <div class="col-6">
              <div class="mb-3">
                <label class="form-label">Min Bekleme (sn)</label>
                <input type="number" class="form-control" id="likeDelayMin" value="{{ config.like_delay_min }}" min="10" max="300">
              </div>
            </div>
            <div class="col-6">
              <div class="mb-3">
                <label class="form-label">Max Bekleme (sn)</label>
                <input type="number" class="form-control" id="likeDelayMax" value="{{ config.like_delay_max }}" min="30" max="600">
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <h6>Takip Ayarları</h6>
          <div class="mb-3">
            <label class="form-label">Günlük Takip Limiti</label>
            <input type="number" class="form-control" id="dailyFollowLimit" value="{{ config.daily_follow_limit }}" min="1" max="500">
          </div>
          <div class="row">
            <div class="col-6">
              <div class="mb-3">
                <label class="form-label">Min Bekleme (sn)</label>
                <input type="number" class="form-control" id="followDelayMin" value="{{ config.follow_delay_min }}" min="30" max="600">
              </div>
            </div>
            <div class="col-6">
              <div class="mb-3">
                <label class="form-label">Max Bekleme (sn)</label>
                <input type="number" class="form-control" id="followDelayMax" value="{{ config.follow_delay_max }}" min="60" max="1200">
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="mt-3">
        <button class="btn btn-success" id="saveConfigBtn">Ayarları Kaydet</button>
      </div>
    </div>
  </div>

  <!-- Schedule Information -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Program Bilgisi</h5>
    </div>
    <div class="card-body">
      <div class="alert alert-info">
        <h6><i class="bi bi-info-circle"></i> Otomatik Programlama</h6>
        <p class="mb-2">Sistem etkinleştirildiğinde aşağıdaki aktiviteler otomatik olarak gerçekleştirilir:</p>
        <ul class="mb-0">
          <li><strong>Session Canlı Tutma:</strong> Belirlenen aralıklarla tüm session'lar canlı tutulur</li>
          <li><strong>Akıllı Bekleme:</strong> İnsan benzeri davranış için rastgele beklemeler</li>
          <li><strong>Günlük Limitler:</strong> Instagram limitlerini aşmamak için kontroller</li>
          <li><strong>Hata Yönetimi:</strong> Bloklanma durumunda otomatik session değiştirme</li>
        </ul>
      </div>
      
      <div class="alert alert-warning">
        <h6><i class="bi bi-exclamation-triangle"></i> Güvenlik Uyarıları</h6>
        <ul class="mb-0">
          <li>Günlük limitleri Instagram'ın resmi limitlerinden düşük tutun</li>
          <li>Çok hızlı işlemler yapmayın, doğal davranış sergileyin</li>
          <li>Session'ları düzenli olarak kontrol edin</li>
          <li>Şüpheli aktivite durumunda sistemi durdurun</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Manual Controls -->
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">Manuel Kontroller</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4">
          <button class="btn btn-primary w-100 mb-2" id="testSystemBtn">
            <i class="bi bi-play-circle"></i> Sistem Testini Çalıştır
          </button>
          <small class="text-muted">Tüm session'ları test eder ve rapor verir</small>
        </div>
        <div class="col-md-4">
          <button class="btn btn-success w-100 mb-2" id="forceKeepAliveBtn">
            <i class="bi bi-heart-pulse"></i> Zorla Canlı Tut
          </button>
          <small class="text-muted">Tüm session'ları manuel olarak canlı tutar</small>
        </div>
        <div class="col-md-4">
          <button class="btn btn-danger w-100 mb-2" id="emergencyStopBtn">
            <i class="bi bi-stop-circle"></i> Acil Durdur
          </button>
          <small class="text-muted">Tüm otomatik aktiviteleri durdurur</small>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Save configuration
  document.getElementById('saveConfigBtn').addEventListener('click', function() {
    const config = {
      enabled: document.getElementById('activityEnabled').checked,
      session_keep_alive_interval: parseInt(document.getElementById('keepAliveInterval').value),
      daily_like_limit: parseInt(document.getElementById('dailyLikeLimit').value),
      like_delay_min: parseInt(document.getElementById('likeDelayMin').value),
      like_delay_max: parseInt(document.getElementById('likeDelayMax').value),
      daily_follow_limit: parseInt(document.getElementById('dailyFollowLimit').value),
      follow_delay_min: parseInt(document.getElementById('followDelayMin').value),
      follow_delay_max: parseInt(document.getElementById('followDelayMax').value)
    };

    // Validation
    if (config.like_delay_min >= config.like_delay_max) {
      showAlert('Beğeni minimum bekleme süresi maksimumdan küçük olmalı', 'danger');
      return;
    }

    if (config.follow_delay_min >= config.follow_delay_max) {
      showAlert('Takip minimum bekleme süresi maksimumdan küçük olmalı', 'danger');
      return;
    }

    this.disabled = true;
    this.textContent = 'Kaydediliyor...';

    fetch('{{ url_for("activity.api_config") }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showAlert('Ayarlar başarıyla kaydedildi', 'success');
      } else {
        showAlert(data.error, 'danger');
      }
      this.disabled = false;
      this.textContent = 'Ayarları Kaydet';
    })
    .catch(error => {
      showAlert('Bir hata oluştu: ' + error.message, 'danger');
      this.disabled = false;
      this.textContent = 'Ayarları Kaydet';
    });
  });

  // Test system
  document.getElementById('testSystemBtn').addEventListener('click', function() {
    this.disabled = true;
    this.innerHTML = '<i class="bi bi-hourglass-split"></i> Test yapılıyor...';

    // This would be a comprehensive system test
    fetch('{{ url_for("activity.api_stats") }}')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showAlert('Sistem testi tamamlandı - tüm bileşenler çalışıyor', 'success');
      } else {
        showAlert('Sistem testinde sorun tespit edildi', 'warning');
      }
      this.disabled = false;
      this.innerHTML = '<i class="bi bi-play-circle"></i> Sistem Testini Çalıştır';
    })
    .catch(error => {
      showAlert('Test sırasında hata oluştu: ' + error.message, 'danger');
      this.disabled = false;
      this.innerHTML = '<i class="bi bi-play-circle"></i> Sistem Testini Çalıştır';
    });
  });

  // Force keep alive
  document.getElementById('forceKeepAliveBtn').addEventListener('click', function() {
    this.disabled = true;
    this.innerHTML = '<i class="bi bi-hourglass-split"></i> Canlı tutuluyor...';

    fetch('{{ url_for("activity.api_keep_alive") }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const result = data.result;
        showAlert(`${result.sessions_activated}/${result.sessions_checked} session canlı tutuldu`, 'success');
      } else {
        showAlert(data.error, 'danger');
      }
      this.disabled = false;
      this.innerHTML = '<i class="bi bi-heart-pulse"></i> Zorla Canlı Tut';
    })
    .catch(error => {
      showAlert('Bir hata oluştu: ' + error.message, 'danger');
      this.disabled = false;
      this.innerHTML = '<i class="bi bi-heart-pulse"></i> Zorla Canlı Tut';
    });
  });

  // Emergency stop
  document.getElementById('emergencyStopBtn').addEventListener('click', function() {
    if (!confirm('Tüm otomatik aktiviteleri durdurmak istediğinizden emin misiniz?')) {
      return;
    }

    this.disabled = true;
    this.innerHTML = '<i class="bi bi-hourglass-split"></i> Durduruluyor...';

    fetch('{{ url_for("activity.api_toggle") }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ enabled: false })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showAlert('Tüm otomatik aktiviteler durduruldu', 'success');
        document.getElementById('activityEnabled').checked = false;
      } else {
        showAlert(data.error, 'danger');
      }
      this.disabled = false;
      this.innerHTML = '<i class="bi bi-stop-circle"></i> Acil Durdur';
    })
    .catch(error => {
      showAlert('Bir hata oluştu: ' + error.message, 'danger');
      this.disabled = false;
      this.innerHTML = '<i class="bi bi-stop-circle"></i> Acil Durdur';
    });
  });

  function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
      alertDiv.remove();
    }, 5000);
  }
});
</script>
{% endblock %}