<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Reklam Y√∂netimi ¬∑ InstaVido</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body{background:#f6f7fb}
    .wrap{max-width:1400px;margin:24px auto;padding:0 16px}
    .title{display:flex;align-items:center;gap:12px;margin-bottom:16px}
    .layout{display:grid;grid-template-columns:320px 1fr;gap:16px}
    @media (max-width:991.98px){.layout{grid-template-columns:1fr}}

    .panel{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    .panel .head{padding:14px 16px;border-bottom:1px solid #eef2f7;display:flex;align-items:center;gap:10px}
    .panel .body{padding:14px 16px}

    .slot-search{display:flex;gap:8px}
    .slot-list{max-height:70vh;overflow:auto}
    .slot-item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border:1px solid #eef2f7;border-radius:10px;margin-bottom:8px;cursor:pointer;background:#fff}
    .slot-item.active{outline:2px solid #2563eb22;background:#f8fbff}
    .slot-label{font-weight:600}
    .muted{color:#6b7280;font-size:12px}

    .detail-grid{display:grid;grid-template-columns:1fr;gap:12px}
    .code-area{width:100%;min-height:220px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .preview{border:1px solid #e5e7eb;border-radius:10px;min-height:160px;width:100%}
    .pill{padding:4px 8px;border-radius:999px;font-size:12px}
    .pill.on{background:#e8fff3;color:#0f5132}
    .pill.off{background:#fff1f2;color:#842029}
    .small-note{font-size:12px;color:#6b7280}
  </style>
</head>
<body>
<div class="wrap">
  <div class="title">
    <h3 class="m-0">üì¢ Reklam Y√∂netimi</h3>
    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('admin.dashboard') }}">‚Üê Dashboard</a>
  </div>

  <div class="layout">
    <!-- Sol: Slot listesi -->
    <div class="panel">
      <div class="head">
        <strong>Slotlar</strong>
        <button class="btn btn-primary btn-sm ms-auto" data-bs-toggle="modal" data-bs-target="#addSlotModal">
          ‚ûï Yeni Slot
        </button>
      </div>
      <div class="body">
        <div class="slot-search mb-2">
          <input id="slotFilter" class="form-control form-control-sm" placeholder="Ara (etiket/anahtar)">
          <button id="btnSaveAll" class="btn btn-outline-success btn-sm">T√ºm√ºn√º Kaydet</button>
        </div>
        <div id="slotList" class="slot-list"></div>
      </div>
    </div>

    <!-- Saƒü: Detay -->
    <div class="panel">
      <div class="head">
        <strong id="detLabel">Detay</strong>
        <span class="muted ms-2" id="detKey"></span>
        <span class="pill ms-2" id="detState"></span>
        <div class="ms-auto d-flex gap-2">
          <button class="btn btn-success btn-sm" id="btnSaveOne">Kaydet</button>
          <button class="btn btn-outline-danger btn-sm" id="btnDelete">Sil</button>
        </div>
      </div>
      <div class="body">
        <form id="formOne">
          <div class="mb-2">
            <label class="form-label">Etiket</label>
            <input id="detLabelInput" class="form-control form-control-sm" placeholder="G√∂r√ºnen ad">
          </div>
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="detEnabled">
            <label class="form-check-label" for="detEnabled">Aktif</label>
          </div>
          <div class="detail-grid">
            <div>
              <label class="form-label">Kod</label>
              <textarea id="detCode" class="form-control code-area" spellcheck="false" placeholder="Reklam HTML/JS kodu"></textarea>
              <div class="d-flex gap-2 mt-2">
                <button type="button" class="btn btn-secondary btn-sm" id="btnLoadPreview">√ñnizleme</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="btnClearPreview">Temizle</button>
              </div>
              <div class="small-note mt-2">
                Script i√ßeren kodlar desteklenir. <code>document.write</code> kullanan eski kodlar otomatik patch‚Äôlenir.
              </div>
            </div>
            <div>
              <label class="form-label">√ñnizleme</label>
              <iframe id="prevFrame" class="preview"></iframe>
            </div>
          </div>
        </form>

        <hr>
        <h6>Interstitial Ayarlarƒ±</h6>
        <form id="formInter">
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="interEnabled" {% if inter.enabled %}checked{% endif %}>
            <label class="form-check-label" for="interEnabled">Aktif</label>
          </div>
          <div class="row g-2">
            <div class="col-4">
              <label class="form-label">ƒ∞lkinden sonra min</label>
              <input id="interMin" type="number" min="1" class="form-control form-control-sm" value="{{ inter.min_after_first or 2 }}">
            </div>
            <div class="col-4">
              <label class="form-label">ƒ∞lkinden sonra max</label>
              <input id="interMax" type="number" min="1" class="form-control form-control-sm" value="{{ inter.max_after_first or 5 }}">
            </div>
            <div class="col-4">
              <label class="form-label">Cool down (dk)</label>
              <input id="interCooldown" type="number" min="1" class="form-control form-control-sm" value="{{ inter.cooldown_minutes or 30 }}">
            </div>
          </div>
          <div class="text-end mt-2">
            <button type="button" id="btnInterSave" class="btn btn-outline-primary btn-sm">Kaydet</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Yeni Slot Modal -->
<div class="modal fade" id="addSlotModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Yeni Slot Ekle</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <form id="addForm">
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label">Anahtar (√∂rn: header_top)</label>
              <input name="key" class="form-control" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Etiket</label>
              <input name="label" class="form-control" placeholder="G√∂r√ºnen ad (opsiyonel)">
            </div>
            <div class="col-md-4">
              <label class="form-label d-block">Durum</label>
              <div class="form-check form-switch mt-2">
                <input id="addEnabled" class="form-check-input" type="checkbox">
                <label class="form-check-label">Aktif</label>
              </div>
            </div>
          </div>
          <div class="mt-3">
            <label class="form-label">Kod</label>
            <textarea name="code" class="form-control" rows="8" spellcheck="false"></textarea>
          </div>
          <div class="text-end mt-3">
            <button class="btn btn-primary">Ekle</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const SLOTS = {};
  {% for s in slots %}
    SLOTS["{{ s.key }}"] = { label: {{ s.label|tojson }}, enabled: {{ 'true' if s.enabled else 'false' }}, code: {{ s.code|tojson }} };
  {% endfor %}

  const $ = (sel) => document.querySelector(sel);

  const listEl = $("#slotList");
  const detLabel = $("#detLabel");
  const detKey = $("#detKey");
  const detState = $("#detState");
  const detLabelInput = $("#detLabelInput");
  const detEnabled = $("#detEnabled");
  const detCode = $("#detCode");
  const prevFrame = $("#prevFrame");

  let currentKey = null;

  function statePill(on){
    detState.textContent = on ? "Aktif" : "Pasif";
    detState.className = "pill " + (on ? "on" : "off");
  }

  function renderList(filterText=""){
    listEl.innerHTML = "";
    const keys = Object.keys(SLOTS).sort();
    keys.forEach(key=>{
      const s = SLOTS[key];
      const hay = (key + " " + (s.label||"")).toLowerCase();
      if(filterText && !hay.includes(filterText)) return;
      const row = document.createElement("div");
      row.className = "slot-item" + (currentKey===key?" active":"");
      row.dataset.key = key;
      row.innerHTML = `
        <div>
          <div class="slot-label">${s.label || key}</div>
          <div class="muted">${key}</div>
        </div>
        <div class="form-check form-switch">
          <input class="form-check-input slot-toggle" type="checkbox" ${s.enabled ? "checked":""}>
        </div>
      `;
      listEl.appendChild(row);
    });
  }

  function loadDetail(key){
    currentKey = key;
    const s = SLOTS[key];
    Array.from(document.querySelectorAll(".slot-item")).forEach(el=>el.classList.toggle("active", el.dataset.key===key));
    detLabel.textContent = s.label || key;
    detKey.textContent = key;
    detLabelInput.value = s.label || key;
    detEnabled.checked = !!s.enabled;
    statePill(!!s.enabled);
    detCode.value = s.code || "";
    // temizle preview
    $("#btnClearPreview").click();
  }

  function loadPreview(){
    const code = detCode.value || "";
    const iframe = prevFrame;
    const safe = code.replace(/<\/script/gi, '<\\/script>').replace(/`/g,'\\`');
    const html = `
<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<style>body{margin:0;padding:8px;font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif}</style>
</head><body>
<div id="ad-slot"></div>
<script>
(function(){
  const wrap = document.getElementById("ad-slot");
  // document.write patch
  const _w = document.write; document.write = function(h){ try{ wrap.insertAdjacentHTML('beforeend', h); }catch(e){} };
  try{
    wrap.innerHTML = \`${safe}\`;
    // i√ßteki script‚Äôleri √ßalƒ±≈ütƒ±r
    const scripts = Array.from(wrap.querySelectorAll('script'));
    (async function run(){
      for(const sc of scripts){
        const s = document.createElement('script');
        for(const a of sc.attributes){ s.setAttribute(a.name, a.value); }
        if(sc.src){ await new Promise(r=>{ s.onload=r; s.onerror=r; wrap.appendChild(s); }); }
        else { s.text = sc.text || sc.innerHTML || ""; wrap.appendChild(s); }
        sc.remove();
      }
      document.write = _w;
    })();
  }catch(e){ wrap.innerText = "√ñnizleme hatasƒ±: " + e.message; document.write=_w; }
})();
<\/script>
</body></html>`;
    iframe.setAttribute("srcdoc", html);
  }

  function clearPreview(){
    prevFrame.setAttribute("srcdoc", "");
  }

  // --- Events ---
  document.body.addEventListener("change", async (e)=>{
    const sw = e.target.closest(".slot-toggle");
    if(!sw) return;
    const row = e.target.closest(".slot-item");
    const key = row.dataset.key;
    const enabled = sw.checked;
    const res = await fetch(`/srdr-proadmin/ads/toggle/${encodeURIComponent(key)}`, {
      method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({enabled})
    });
    if(res.ok){
      SLOTS[key].enabled = enabled;
      if(currentKey===key){ detEnabled.checked = enabled; statePill(enabled); }
    }else{
      alert("Toggle ba≈üarƒ±sƒ±z"); sw.checked = !enabled;
    }
  });

  listEl.addEventListener("click", (e)=>{
    const item = e.target.closest(".slot-item");
    if(!item) return;
    if(e.target.classList.contains("slot-toggle") || e.target.closest(".slot-toggle")) return;
    loadDetail(item.dataset.key);
  });

  $("#slotFilter").addEventListener("input", (e)=> renderList(e.target.value.trim().toLowerCase()) );

  $("#btnLoadPreview").addEventListener("click", loadPreview);
  $("#btnClearPreview").addEventListener("click", clearPreview);

  $("#btnSaveOne").addEventListener("click", async ()=>{
    if(!currentKey) return;
    const p = new URLSearchParams();
    const en = detEnabled.checked ? "on" : "";
    p.append(`slots[${currentKey}][enabled]`, en);
    p.append(`slots[${currentKey}][label]`, detLabelInput.value || currentKey);
    p.append(`slots[${currentKey}][code]`, detCode.value || "");
    const res = await fetch("/srdr-proadmin/ads/save", { method:"POST", body:p });
    if(res.ok){
      // local
      SLOTS[currentKey].enabled = !!en;
      SLOTS[currentKey].label   = detLabelInput.value || currentKey;
      SLOTS[currentKey].code    = detCode.value || "";
      detLabel.textContent = SLOTS[currentKey].label;
      statePill(SLOTS[currentKey].enabled);
      renderList($("#slotFilter").value.trim().toLowerCase());
      const btn = $("#btnSaveOne"); const t = btn.textContent; btn.textContent="Kaydedildi"; setTimeout(()=>btn.textContent=t,800);
    }else{
      alert("Kayƒ±t ba≈üarƒ±sƒ±z");
    }
  });

  $("#btnDelete").addEventListener("click", async ()=>{
    if(!currentKey) return;
    if(!confirm(`${currentKey} silinsin mi?`)) return;
    const res = await fetch(`/srdr-proadmin/ads/delete/${encodeURIComponent(currentKey)}`, { method:"POST" });
    if(res.ok){
      delete SLOTS[currentKey];
      currentKey = null;
      renderList($("#slotFilter").value.trim().toLowerCase());
      // birini se√ß
      const fk = Object.keys(SLOTS).sort()[0];
      if(fk) loadDetail(fk);
      else { detLabel.textContent="Detay"; detKey.textContent=""; detCode.value=""; clearPreview(); }
    }else{
      alert("Silinemedi");
    }
  });

  $("#btnSaveAll").addEventListener("click", async ()=>{
    const p = new URLSearchParams();
    Object.keys(SLOTS).forEach(key=>{
      const s = SLOTS[key];
      p.append(`slots[${key}][enabled]`, s.enabled ? "on" : "");
      p.append(`slots[${key}][label]`, s.label || key);
      p.append(`slots[${key}][code]`, s.code || "");
    });
    const res = await fetch("/srdr-proadmin/ads/save", { method:"POST", body:p });
    if(res.ok) alert("T√ºm slotlar kaydedildi.");
    else alert("Kayƒ±t ba≈üarƒ±sƒ±z.");
  });

  $("#addForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const fd = new FormData(e.target);
    const payload = {
      key: (fd.get("key")||"").trim(),
      label: (fd.get("label")||"").trim(),
      enabled: $("#addEnabled").checked,
      code: fd.get("code") || ""
    };
    const res = await fetch("/srdr-proadmin/ads/add", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload) });
    if(res.ok){
      SLOTS[payload.key] = { label: payload.label || payload.key, enabled: !!payload.enabled, code: payload.code };
      renderList($("#slotFilter").value.trim().toLowerCase());
      bootstrap.Modal.getInstance(document.getElementById('addSlotModal')).hide();
      e.target.reset(); $("#addEnabled").checked = false;
      loadDetail(payload.key);
    }else{
      const j = await res.json().catch(()=>({msg:"Hata"}));
      alert(j.msg || "Ekleme ba≈üarƒ±sƒ±z");
    }
  });

  $("#btnInterSave").addEventListener("click", async ()=>{
    const p = new URLSearchParams();
    if($("#interEnabled").checked) p.append("enabled","on");
    p.append("min_after_first", $("#interMin").value || "2");
    p.append("max_after_first", $("#interMax").value || "5");
    p.append("cooldown_minutes", $("#interCooldown").value || "30");
    const res = await fetch("/srdr-proadmin/ads/interstitial/save", { method:"POST", body:p });
    if(res.ok) alert("Interstitial kaydedildi."); else alert("Kayƒ±t ba≈üarƒ±sƒ±z.");
  });

  // ƒ∞lk render
  renderList();
  const first = Object.keys(SLOTS).sort()[0];
  if(first) loadDetail(first);
})();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
